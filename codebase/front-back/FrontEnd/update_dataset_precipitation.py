# -*- coding: utf-8 -*-
"""
Created on Thu Jun 23 19:43:28 2022

Script that daily update precipitation dataset cronjob every day at 7am

@author: Edwin Cifuentes - Team30 DS4A - Cohort 6
Finish date: 7 de julio de 2022
"""

#!pip install sodapy
import pandas as pd
import numpy as np
import time
from datetime import datetime
from datetime import timedelta
from sodapy import Socrata

def optain_divipola(dep,mun,divipola):
    dep = str(dep).strip()
    mun = str(mun).strip()
    parentesis = str(mun).find("(")
    if parentesis > -1:
        mun = mun[:parentesis].strip()
    consulta = divipola[(divipola["Nombre Departamento"] == dep) & (divipola["Nombre Municipio"]==mun)]["Código Municipio"]
    resultado = str(consulta.min()) if len(consulta)>0 else np.nan
    return resultado

dic_mun = {"EL ATRATO":"EL CARMEN DE ATRATO",
           "CÚCUTA":"SAN JOSÉ DE CÚCUTA",
           "CARTAGENA":"CARTAGENA DE INDIAS",
           "BOGOTA D.C.":"BOGOTÁ. D.C.",
           "BOGOTA, D.C":"BOGOTÁ. D.C.",
           "BOGOTA, D.C.":"BOGOTÁ. D.C.",
           "EL TABLÓN":"EL TABLÓN DE GÓMEZ",
           "TUMACO":"SAN ANDRÉS DE TUMACO",
           "VILLAMARIA":"VILLAMARÍA",
           "JURADO":"JURADÓ",
           "EL CARMÉN DE BOLÍVAR":"EL CARMEN DE BOLÍVAR",
           "PISVA":"PISBA",
           "VILLA DE LEIVA":"VILLA DE LEYVA",
           "GUICÁN":"GÜICÁN DE LA SIERRA",
           "PIVIJAI":"PIVIJAY",
           "SAN ANDRES Y PROVIDENCIA (SANTA ISABEL)":"PROVIDENCIA",
           "SAN ANDRES Y  PROVIDENCIA (SANTA ISABEL)":"PROVIDENCIA",
           "ENTRERRIOS":"ENTRERRÍOS",
           "BUGA":"GUADALAJARA DE BUGA",
           "TOLÚ":"SANTIAGO DE TOLÚ",
           "CHINCHINA":"CHINCHINÁ",
           "SUPIA":"SUPÍA",
           "ZETAQUIRÁ":"ZETAQUIRA",
           "UBATÉ":"VILLA DE SAN DIEGO DE UBATÉ",
           "BELALCAZAR":"BELALCÁZAR",
           "SAN JOSE":"SAN JOSÉ",
           "SANTA FE DE ANTIOQUIA":"SANTA FÉ DE ANTIOQUIA",
           "PIENDAMÓ":"PIENDAMÓ - TUNÍA",
           "EL PAUJIL":"EL PAUJÍL",
           "RIO QUITO (PAIMADÓ)":"RÍO QUITO",
           "RIO IRO":"RÍO IRÓ",
           "LITORAL DEL SAN JUAN":"EL LITORAL DEL SAN JUAN",
           "MARIQUITA":"SAN SEBASTIÁN DE MARIQUITA",
           "VIGIA DEL FUERTE":"VIGÍA DEL FUERTE",
           "MANI":"MANÍ",
           "IBAGUE":"IBAGUÉ",
           "MEDELLIN":"MEDELLÍN",
           "QUIBDO":"QUIBDÓ",
           "PLANETARICA":"PLANETA RICA",
           "PUERTO LIBERTADOr":"PUERTO LIBERTADOR",
           "PUERTO LOPEZ":"PUERTO LÓPEZ",
           "POPAYAN":"POPAYÁN",
           "JAMUNDI":"JAMUNDÍ",
           "CARMEN DE APICALA":"CARMEN DE APICALÁ",
           "CAPARRAPI":"CAPARRAPÍ",
           "PEÑON":"EL PEÑÓN",
           " EL CALVARIO":"EL CALVARIO",
           "PUERTO GAITAN":"PUERTO GAITÁN",
           "CAQUEZA":"CÁQUEZA",
           "CUCUTA":"SAN JOSÉ DE CÚCUTA",
           "CIENAGA":"CIÉNAGA",
           "LIBANO":"LÍBANO",
           "FUSAGASUGA":"FUSAGASUGÁ",
           "CALARCA":"CALARCÁ",
           "GIRON":"GIRÓN",
           "BOGOTA":"BOGOTÁ. D.C.",
           "OROCUE":"OROCUÉ",
           "FOMEQUE":"FÓMEQUE",
           "MONTERIA":"MONTERÍA",
           "GARZON":"GARZÓN",
           "SUAREZ":"SUÁREZ",
           "PUERTO BOYACA":"PUERTO BOYACÁ",
           "CAJIBIO":"CAJIBÍO",
           "MISTRATO":"MISTRATÓ",
           "APIA":"APÍA",
           "PURIFICACION":"PURIFICACIÓN",
           "JUNIN":"JUNÍN",
           "GACHETA":"GACHETÁ",
           "GUATICA":"GUÁTICA",
           "VIOTA":"VIOTÁ",
           "BELEN DE UMBRIA":"BELÉN DE UMBRÍA",
           "TIMBIO":"TIMBÍO",
           "TIMANA":"TIMANÁ",
           "UTICA":"ÚTICA",
           "TIMBIQUI":"TIMBIQUÍ",
           "SAN JOSE DEL GUAVIARE":"SAN JOSÉ DEL GUAVIARE",
           "INIRIDA":"INÍRIDA",
           "CHOACHI":"CHOACHÍ",
           "QUINCHIA":"QUINCHÍA",
           "SAN VICENTE DE CHUCURI":"SAN VICENTE DE CHUCURÍ",
           "GUACHETA":"GUACHETÁ",
           "ZIPAQUIRA":"ZIPAQUIRÁ",
           "YAGUARA":"YAGUARÁ",
           "ABREGO":"ABREGÓ",
            "PATIA":"PATÍA",
            "NUNCHIA":"NUNCHÍA",
            "NACION":"NACIÓN",
            "SIBATE":"SIBATÉ",
            "UBATE":"VILLA DE SAN DIEGO DE UBATÉ",
            "BOLIVAR":"BOLÍVAR",
            "FUNDACION":"FUNDACIÓN",
            "INZA":"INZÁ",
            "TIBU":"TIBÚ",
            "LLORO":"LLORÓ",
            "YACOPI":"YACOPÍ",
            "PUERTO ASIS":"PUERTO ASÍS",
            "TADO":"TADÓ",
            "LERIDA":"LÉRIDA",
            "ITAGUI":"ITAGÜÍ",
            "EL PLAYON":"EL PLAYÓN",
            "MEDIO BAUDO":"MEDIO BAUDÓ",
            "PUERTO LEGUIZAMO":"PUERTO LEGUÍZAMO",
            "SAMACA":"SAMACÁ",
            "APARTADO":"APARTADÓ",
            "SAN MARTIN":"SAN MARTÍN",
            "MITU":"MITÚ",
            "UBALA":"UBALÁ",
            "LOPEZ DE MICAY":"LÓPEZ DE MICAY",
            "SAN ANDRES DE TUMACO":"SAN ANDRÉS DE TUMACO",
            "MONTELIBANO":"MONTELÍBANO",
            "GENOVA":"GÉNOVA",
            "ACACIAS":"ACACÍAS",
           "ABREGÓ":"ÁBREGÓ",
           "ÁBREGÓ":"ÁBREGO",
            "SAN ANDRES":"SAN ANDRÉS",
            "GALAN":"GALÁN",
            "SAN VICENTE DEL CAGUAN":"SAN VICENTE DEL CAGUÁN",
            "FACATATIVA":"FACATATIVÁ",
            "CURUMANI":"CURUMANÍ",
            "CHIGORODO":"CHIGORODÓ",
            "NATAGA":"NÁTAGA",
            "PAEZ":"PÁEZ",
            "BAJO BAUDO":"BAJO BAUDÓ",
            "PUERTO GUZMAN":"PUERTO GUZMÁN",
            "CHITAGA":"CHITAGÁ",
            "SAN AGUSTIN":"SAN AGUSTÍN",
            "CHACHAGUI":"CHACHAGÜÍ",
            "ALTO BAUDO":"ALTO BAUDÓ",
            "GUTIERREZ":"GUTIÉRREZ",
            "BOJAYA":"BOJAYÁ",
            "DEPARTAMENTO":"DEPARTAMENTO",
            "NECHI":"NECHÍ",
            "SANTA MARIA":"SANTA MARÍA",
            "CHOCONTA":"CHOCONTÁ",
            "MAGANGUE":"MAGANGUÉ",
            "CUCUNUBA":"CUCUNUBÁ",
            "AMAGA":"AMAGÁ",
            "MANATI":"MANATÍ",
            "BAHIA SOLANO":"BAHÍA SOLANO",
            "RAQUIRA":"RÁQUIRA",
            "GACHALA":"GACHALÁ",
            "VELEZ":"VÉLEZ",
            "PUERTO BERRIO":"PUERTO BERRÍO",
            "LA UNION":"LA UNIÓN",
            "UNGUIA":"UNGUÍA",
            "AGUSTIN CODAZZI":"AGUSTÍN CODAZZI",
            "SANDONA":"SANDONÁ",
            "SOTARA":"SOTARÁ",
            "CHINACOTA":"CHINÁCOTA",
            "COCORNA":"COCORNÁ",
            "CHIA":"CHÍA",
            "CARMEN DEL DARIEN":"CARMEN DEL DARIÉN",
            "TAMARA":"TÁMARA",
            "ALBAN":"ALBÁN",
            "BOJACA":"BOJACÁ",
            "IQUIRA":"ÍQUIRA",
            "MONIQUIRA":"MONIQUIRÁ",
            "CORDOBA":"CÓRDOBA",
            "NOVITA":"NÓVITA",
            "TOPAIPI":"TOPAIPÍ",
            "TORIBIO":"TORIBÍO",
            "PURACE":"PURACÉ",
            "SAMANA":"SAMANÁ",
            "CONSACA":"CONSACÁ",
            "VILLAGARZON":"VILLAGARZÓN",
            "TOCANCIPA":"TOCANCIPÁ",
            "TUQUERRES":"TÚQUERRES",
            "ACHI":"ACHÍ",
           "SOTARÁ":"SOTARÁ PAISPAMBA",
            "ROBERTO PAYAN":"ROBERTO PAYÁN",
            "CHIQUINQUIRA":"CHIQUINQUIRÁ",
            "RIO QUITO":"RÍO QUITO",
            "PIENDAMO":"PIENDAMÓ",
            "VILLAPINZON":"VILLAPINZÓN",
            "ANZOATEGUI":"ANZOÁTEGUI",
            "CACHIRA":"CÁCHIRA",
            "BAGADO":"BAGADÓ",
            "SAN JUAN DE RIO SECO":"SAN JUAN DE RIOSECO",
            "FUQUENE":"FÚQUENE",
            "MALAGA":"MÁLAGA",
            "ANORI":"ANORÍ",
            "CURITI":"CURITÍ",
            "CERETE":"CERETÉ",
            "NECOCLI":"NECOCLÍ",
            "REPELON":"REPELÓN",
            "TARAZA":"TARAZÁ",
            "BELTRAN":"BELTRÁN",
            "CIENAGA DE ORO":"CIÉNAGA DE ORO",
            "CARTAGENA DEL CHAIRA":"CARTAGENA DEL CHAIRÁ",
            "QUIPAMA":"QUÍPAMA",
            "SANTA BARBARA":"SANTA BÁRBARA",
           "PIENDAMÓ":"PIENDAMÓ - TUNÍA",
            "VILLAGOMEZ":"VILLAGÓMEZ",
            "TIBANA":"TIBANÁ",
            "NEMOCON":"NEMOCÓN",
            "LEJANIAS":"LEJANÍAS",
            "CHIRIGUANA":"CHIRIGUANÁ",
            "MAGUI PAYAN":"MAGÜÍ",
            "SESQUILE":"SESQUILÉ",
            "SOATA":"SOATÁ",
            "SOCOTA":"SOCOTÁ",
            "YONDO":"YONDÓ",
            "SIMITI":"SIMITÍ",
            "CAJICA":"CAJICÁ",
            "LOS CORDOBAS":"LOS CÓRDOBAS",
            "BELEN":"BELÉN",
            "ACANDI":"ACANDÍ",
            "EL PEÑON":"EL PEÑÓN",
            "TULUA":"TULUÁ",
            "LANDAZURI":"LANDÁZURI",
            "GAMEZA":"GÁMEZA",
            "SANTIAGO DE TOLU":"SANTIAGO DE TOLÚ",
            "SOTAQUIRA":"SOTAQUIRÁ",
            "EL CARMEN DE BOLIVAR":"EL CARMEN DE BOLÍVAR",
           "RIOFRIO":"RIOFRÍO",
            "EL AGUILA":"EL ÁGUILA",
            "GUACARI":"GUACARÍ",
            "ARBELAEZ":"ARBELÁEZ",
            "CACOTA":"CÁCOTA",
            "TOTORO":"TOTORÓ",
            "EL TABLON DE GOMEZ":"EL TABLÓN DE GÓMEZ",
            "GUAYABAL DE SIQUIMA":"GUAYABAL DE SÍQUIMA",
            "MURINDO":"MURINDÓ",
            "VIANI":"VIANÍ",
            "CUBARA":"CUBARÁ",
            "SAN JOSE DEL PALMAR":"SAN JOSÉ DEL PALMAR",
            "SAN SEBASTIAN":"SAN SEBASTIÁN",
            "BELEN DE LOS ANDAQUIES":"BELÉN DE LOS ANDAQUÍES",
            "COLON":"COLÓN",
            "SIPI":"SIPÍ",
            "SAN VICENTE":"SAN VICENTE FERRER",
            "MUTATA":"MUTATÁ",
            "GAMBITA":"GÁMBITA",
            "VEGACHI":"VEGACHÍ",
            "ANDALUCIA":"ANDALUCÍA",
           "BARRANCA DE UPIA":"BARRANCA DE UPÍA",
            "CACERES":"CÁCERES",
            "CEPITA":"CEPITÁ",
            "CANTON DE SAN PABLO":"EL CANTÓN DEL SAN PABLO",
            "CHARALA":"CHARALÁ",
            "MAPIRIPAN":"MAPIRIPÁN",
            "SAN JOSE DEL FRAGUA":"SAN JOSÉ DEL FRAGUA",
            "SAMPUES":"SAMPUÉS",
            "PUERTO RONDON":"PUERTO RONDÓN",
            "JERICO":"JERICÓ",
            "PARAMO":"PÁRAMO",
            "CERTEGUI":"CÉRTEGUI",
            "NUQUI":"NUQUÍ",
            "SANTO TOMAS":"SANTO TOMÁS",
            "MACHETA":"MACHETÁ",
            "COMBITA":"CÓMBITA",
            "RAMIRIQUI":"RAMIRIQUÍ",
            "ANGELOPOLIS":"ANGELÓPOLIS",
            "SAHAGUN":"SAHAGÚN",
            "BOYACA":"BOYACÁ",
            "ARIGUANI":"ARIGUANÍ",
            "SURATA":"SURATÁ",
            "PAZ DE RIO":"PAZ DE RÍO",
            "CONVENCION":"CONVENCIÓN",
            "HACARI":"HACARÍ",
            "PULI":"PULÍ",
            "SAN JERONIMO":"SAN JERÓNIMO",
            "SONSON":"SONSÓN",
            "SAN MARTIN DE LOBA":"SAN MARTÍN DE LOBA",
            "RIO VIEJO":"RÍO VIEJO",
            "SANTAFE DE ANTIOQUIA":"SANTA FÉ DE ANTIOQUIA",
            "SANTA LUCIA":"SANTA LUCÍA",
            "CHIQUIZA":"CHÍQUIZA",
            "SAN JOSE DE MIRANDA":"SAN JOSÉ DE MIRANDA",
            "TAMESIS":"TÁMESIS",
            "RIO DE ORO":"RÍO DE ORO",
            "ALCALA":"ALCALÁ",
            "MARIPI":"MARIPÍ",
            "HERRAN":"HERRÁN",
            "CARCASI":"CARCASÍ",
            "PACORA":"PÁCORA",
            "CARACOLI":"CARACOLÍ",
            "ANZA":"ANZÁ",
            "ZIPACON":"ZIPACÓN",
            "TOLU VIEJO":"TOLÚ VIEJO",
            "CUITIVA":"CUÍTIVA",
            "TURMEQUE":"TURMEQUÉ",
            "SOPO":"SOPÓ",
            "TUBARA":"TUBARÁ",
            "CONCEPCION":"CONCEPCIÓN",
            #"RIO IRÓ":"RÍO IRÓ",
            "TOPAGA":"TÓPAGA",
           "TOLÚ VIEJO":"SAN JOSÉ DE TOLUVIEJO",
            "JAMBALO":"JAMBALÓ",
            "TINJACA":"TINJACÁ",
            "GACHANCIPA":"GACHANCIPÁ",
            "EL CONTADERO":"CONTADERO",
            "SABOYA":"SABOYÁ",
            "YOLOMBO":"YOLOMBÓ",
            "NOROSI":"NOROSÍ",
            "SORACA":"SORACÁ",
            "POTOSI":"POTOSÍ",
            "CIUDAD BOLIVAR":"CIUDAD BOLÍVAR",
            "ELIAS":"ELÍAS",
            "EL PIÑON":"EL PIÑÓN",
            "EL RETEN":"EL RETÉN",
            "GUACHENE":"GUACHENÉ",
            "EBEJICO":"EBÉJICO",
            "SACHICA":"SÁCHICA",
            "GUICAN":"GÜICÁN DE LA SIERRA",
            "SUPATA":"SUPATÁ",
            "UNION PANAMERICANA":"UNIÓN PANAMERICANA",
            "BURITICA":"BURITICÁ",
            "MARIA LA BAJA":"MARÍA LA BAJA",
            "TITIRIBI":"TITIRIBÍ",
            "CIENEGA":"CIÉNEGA",
            "VALPARAISO":"VALPARAÍSO",
            "CHIVATA":"CHIVATÁ",
            "SAN CRISTOBAL":"SAN CRISTÓBAL",
            "SANTA ROSALIA":"SANTA ROSALÍA",
            "SAN LUIS DE SINCE":"SAN LUIS DE SINCÉ",
            "VALLE DE SAN JOSE":"VALLE DE SAN JOSÉ",
            "CONTRATACION":"CONTRATACIÓN",
            "GUAVATA":"GUAVATÁ",
            "SANTA HELENA DEL OPON":"SANTA HELENA DEL OPÓN",
            "SAN JOAQUIN":"SAN JOAQUÍN",
            "IMUES":"IMUÉS",
            "LA URIBE":"URIBE",
            "SANTA BARBARA DE PINTO":"SANTA BÁRBARA DE PINTO",
            "ZAPAYAN":"ZAPAYÁN",
            "DISTRACCION":"DISTRACCIÓN",
            "CHAGUANI":"CHAGUANÍ",
            "BOGOTA":"BOGOTÁ. D.C.",
            "PURISIMA":"PURÍSIMA DE LA CONCEPCIÓN",
            "SAN JOSE DE URE":"SAN JOSÉ DE URÉ",
            "CHINU":"CHINÚ",
            "CHAMEZA":"CHÁMEZA",
            "MILAN":"MILÁN",
            "SUTAMARCHAN":"SUTAMARCHÁN",
            "MONGUI":"MONGUÍ",
            "NUEVO COLON":"NUEVO COLÓN",
            "PIOJO":"PIOJÓ",
            "USIACURI":"USIACURÍ",
            "DON MATIAS":"DONMATÍAS",
            "YALI":"YALÍ",
            "GOMEZ PLATA":"GÓMEZ PLATA",
            "JERUSALEN":"JERUSALÉN",
            "SUSACON":"SUSACÓN",
            "GUATAPE":"GUATAPÉ",
            "JARDIN":"JARDÍN",
            "SAN ANDRES DE CUERQUIA":"SAN ANDRÉS DE CUERQUÍA",
            "SAN JUAN DE URABA":"SAN JUAN DE URABÁ",
            #"SAN PEDRO":"SAN PEDRO DE LOS MILAGROS",
            "SAN PEDRO DE URABA":"SAN PEDRO DE URABÁ",
            "SOPETRAN":"SOPETRÁN",
            "CARMEN DE BOLIVAR":"EL CARMEN DE BOLÍVAR",
            "MOMPOS":"SANTA CRUZ DE MOMPOX",
            "MOMPOX":"SANTA CRUZ DE MOMPOX",
            "TURBANA":"TURBANÁ",
            "COVARACHIA":"COVARACHÍA",
            "GUAYATA":"GUAYATÁ",
            "OICATA":"OICATÁ",
            "SAN JOSE DE PARE":"SAN JOSÉ DE PARE",
            "SANTA SOFIA":"SANTA SOFÍA",
            "TOGUI":"TOGÜÍ",
            "VIRACACHA":"VIRACACHÁ",
            "SACAMA":"SÁCAMA",
            "GONZALEZ":"GONZÁLEZ",
            "BOGOTA":"BOGOTÁ. D.C.",
            "GUATAQUI":"GUATAQUÍ",
            "CHIBOLO":"CHIVOLO",
            "PUEBLO VIEJO":"PUEBLOVIEJO",
            "SAN SEBASTIAN DE BUENAVISTA":"SAN SEBASTIÁN DE BUENAVISTA",
            "SAN ZENON":"SAN ZENÓN",
            "CUASPUD":"CUASPUD CARLOSAMA",
            "GUALMATAN":"GUALMATÁN",
            "COLOSO":"COLOSÓ",
           "ALEJANDRIA":"ALEJANDRÍA",
            "MARIALABAJA":"MARÍA LA BAJA",
            "RIOVIEJO":"RÍO VIEJO",
            "GACHANTIVA":"GACHANTIVÁ",
            "RONDON":"RONDÓN",
            "UMBITA":"ÚMBITA",
            "CARMEN DE ATRATO":"EL CARMEN DE ATRATO",
            "CERRO SAN ANTONIO":"CERRO DE SAN ANTONIO",
            "SABANAS DE SAN ANGEL":"SABANAS DE SAN ÁNGEL",
            "LOS ANDES SOTOMAYOR":"LOS ANDES",
            "TABLON DE GOMEZ":"EL TABLÓN DE GÓMEZ",
            "SALAZAR DE LAS PALMAS":"SALAZAR",
            "VILLACARO":"VILLA CARO",
            "CHIPATA":"CHIPATÁ",
            "FLORIAN":"FLORIÁN",
            "GUAPOTA":"GUAPOTÁ",
            "GUEPSA":"GÜEPSA",
            "JESUS MARIA":"JESÚS MARÍA",
            "CHALAN":"CHALÁN",
            "SAN PEDRO DE LOS MILAGROS":"SAN PEDRO",
            "SINCE":"SAN LUIS DE SINCÉ",
            "TOLU":"SANTIAGO DE TOLÚ",
            "ARMERO GUAYABAL":"ARMERO",
            "HERBEO":"HERVEO",
            "RIO IRÓ":"RÍO IRÓ"

             }
dic_dep = {"CHOCO":"CHOCÓ",

           "SAN ANDRÉS PROVIDENCIA":"ARCHIPIÉLAGO DE SAN ANDRÉS. PROVIDENCIA Y SANTA CATALINA",
           "ARCHIPIELAGO DE SAN ANDRES, PROVIDENCIA Y SANTA CATALINA":"ARCHIPIÉLAGO DE SAN ANDRÉS. PROVIDENCIA Y SANTA CATALINA",
           "SAN ANDRES":"ARCHIPIÉLAGO DE SAN ANDRÉS. PROVIDENCIA Y SANTA CATALINA",
           "BOGOTA D.C.":"BOGOTÁ. D.C.",
           "BOGOTA ":"BOGOTÁ. D.C.",
           "BOGOTA":"BOGOTÁ. D.C.",
           "BOGOTA, D.C.":"BOGOTÁ. D.C.",
           "CORDOBA":"CÓRDOBA",
           "BOLIVAR":"BOLÍVAR",
           "ATLANTICO":"ATLÁNTICO",
           "CAQUETA":"CAQUETÁ",
           "NARINO":"NARIÑO",
           "QUINDIO":"QUINDÍO",
           "BOYACA":"BOYACÁ",
           "GUAINIA":"GUAINÍA",
           "VAUPES":"VAUPÉS",
           "VALLE":"VALLE DEL CAUCA",
           "VALLE ":"VALLE DEL CAUCA",
           "GUAJIRA":"LA GUAJIRA",
           "CESÁR":"CESAR"
    
}
divipola = pd.read_csv("datasets/DIVIPOLA.csv", dtype ={'Código Municipio':str}, encoding="utf-8")
divipola = divipola.dropna(subset=["Código Municipio"])

# Unauthenticated client only works with public data sets. Note 'None'
# in place of application token, and no username or password:
#client = Socrata("www.datos.gov.co", None)

# Example authenticated client (needed for non-public datasets):
client = Socrata('www.datos.gov.co',
                  'e57OPBK09DdELuozn9qlCSBtL',
                  username="edwin@cifuentes.com.co",
                  password="tozxeV-gokfon-1tixqo")

# First 2000 results, returned as JSON from API / converted to Python list of
# dictionaries by sodapy.
precipitation = "s54a-sgyg"
start_time = time.time()

now_date_time = datetime.now()
print("INICIO: --- %s ---" % (now_date_time))
before_yesterday = now_date_time - timedelta(days=2)
before_yesterday_str = before_yesterday.strftime("%Y-%m-%d")
fecha_inicio=before_yesterday_str
result = client.get(precipitation, select="*", where="fechaobservacion >= '"+before_yesterday_str+"T00:00:00.000'", limit=200000000)
#result = client.get(precipitation, select="*", where="fechaobservacion >= '2016-12-31T00:00:00.000'", limit=200000000)
#fecha_inicio='2016-12-31'
#result = client.get(precipitation, select="*", where="fechaobservacion between '"+fecha_inicio+"T00:00:00.000' and '2022-06-30T23:59:59.999'", limit=200000000)
if len(result) > 0: 
    df = pd.DataFrame.from_records(result)
    df.fechaobservacion = pd.to_datetime(df.fechaobservacion)
    df.valorobservado = df.valorobservado.astype(float)
    tiempo1 = time.time() - start_time
    interval_time = time.time()
    print("CARGA DE ARCHIVO EN: --- %s seconds ---" % (tiempo1))
    df.sort_values(by=['codigoestacion', 'fechaobservacion'],inplace=True)
    df.reset_index(inplace=True,drop=True)
    tiempo2 = time.time() - interval_time
    print("ORDENADO DE ARCHIVO EN: --- %s seconds ---" % (tiempo2))
    df['T10']=df[['codigoestacion', 'fechaobservacion','valorobservado']].groupby('codigoestacion')[['codigoestacion', 'fechaobservacion','valorobservado']].rolling(min_periods=1,window='10min',on="fechaobservacion").sum().reset_index().valorobservado.round(2)
    df['T30']=df[['codigoestacion', 'fechaobservacion','valorobservado']].groupby('codigoestacion')[['codigoestacion', 'fechaobservacion','valorobservado']].rolling(min_periods=1,window='30min',on="fechaobservacion").sum().reset_index().valorobservado.round(2)
    df['T60']=df[['codigoestacion', 'fechaobservacion','valorobservado']].groupby('codigoestacion')[['codigoestacion', 'fechaobservacion','valorobservado']].rolling(min_periods=1,window='60min',on="fechaobservacion").sum().reset_index().valorobservado.round(2)
    df['T120']=df[['codigoestacion', 'fechaobservacion','valorobservado']].groupby('codigoestacion')[['codigoestacion', 'fechaobservacion','valorobservado']].rolling(min_periods=1,window='120min',on="fechaobservacion").sum().reset_index().valorobservado.round(2)
    df['T360']=df[['codigoestacion', 'fechaobservacion','valorobservado']].groupby('codigoestacion')[['codigoestacion', 'fechaobservacion','valorobservado']].rolling(min_periods=1,window='360min',on="fechaobservacion").sum().reset_index().valorobservado.round(2)
    df['T720']=df[['codigoestacion', 'fechaobservacion','valorobservado']].groupby('codigoestacion')[['codigoestacion', 'fechaobservacion','valorobservado']].rolling(min_periods=1,window='720min',on="fechaobservacion").sum().reset_index().valorobservado.round(2)
    df['T1080']=df[['codigoestacion', 'fechaobservacion','valorobservado']].groupby('codigoestacion')[['codigoestacion', 'fechaobservacion','valorobservado']].rolling(min_periods=1,window='1080min',on="fechaobservacion").sum().reset_index().valorobservado.round(2)
    df['T1440']=df[['codigoestacion', 'fechaobservacion','valorobservado']].groupby('codigoestacion')[['codigoestacion', 'fechaobservacion','valorobservado']].rolling(min_periods=1,window='1440min',on="fechaobservacion").sum().reset_index().valorobservado.round(2)
    
    #df['T10'] = df.groupby(['codigoestacion'])['valorobservado'].transform(lambda s: s.rolling(2, min_periods=1).sum())
    
    
    new_data=df.groupby([df["fechaobservacion"].dt.date,df["codigoestacion"]]).agg(
            codigo_sensor=('codigosensor', min),
            nombre_estacion=('nombreestacion', min),
            departamento=('departamento', min),
            municipio=('municipio', min),
            zona_hidrografica=('zonahidrografica', min),
            latitud=('latitud', min),
            longitud=('longitud', min),
            unidad_medida=('unidadmedida', min),
            descripcion=('descripcionsensor', min),
            anio_observacion=("fechaobservacion",  lambda x: min(x).year),
            doy_observacion=("fechaobservacion",  lambda x: min(x).day_of_year),
            mes_observacion=("fechaobservacion",  lambda x: min(x).month),
            day_observacion=("fechaobservacion",  lambda x: min(x).day),
            valor_observado_avg=('valorobservado', 'mean'),
            valor_observado_min=('valorobservado', min),
            valor_observado_max=('valorobservado', max),
            valor_observado_std=('valorobservado', 'std'), 
            T10_max=('T10', max),
            T30_max=('T30', max),
            T60_max=('T60', max),
            T120_max=('T120', max),
            T360_max=('T360', max),
            T720_max=('T720', max),
            T1080_max=('T1080', max),
            T1440_max=('T1440', max),
            #valor_observado_suma=('valorobservado', sum), 
            #valor_observado_median=('valorobservado', 'median'),
            #observaciones=('valorobservado', 'count'),
            # Apply a lambda to date column
            # num_days=("date", lambda x: (max(x) - min(x)).days)    
        ).reset_index()
    new_data['fechaobservacion'] = pd.to_datetime(new_data['fechaobservacion'])
    new_data = new_data[new_data['fechaobservacion']>fecha_inicio]
    new_data.drop("fechaobservacion", axis = 'columns', inplace=True)
    new_data["departamento"]=new_data["departamento"].replace(dic_dep)
    new_data["municipio"]=new_data["municipio"].replace(dic_mun)
    new_data.loc[(new_data["municipio"]=="EL CARMEN") & (new_data["departamento"]=="CHOCÓ"),"municipio"]="EL CARMEN DE ATRATO"
    new_data.loc[(new_data["municipio"]=="SANTUARIO") & (new_data["departamento"]=="ANTIOQUIA"),"municipio"]="EL SANTUARIO"
    new_data.loc[(new_data["municipio"]=="EL CARMEN") & (new_data["departamento"]=="SANTANDER"),"municipio"]="EL CARMEN DE CHUCURI"
    new_data["DIVIPOLA"] = new_data.apply(
        lambda row: optain_divipola(row["departamento"],row["municipio"],divipola), axis=1)
    new_data.to_csv('datasets/precipitation_interval_max_daily_with_divipola.csv', mode='a', index=False, header=False)
result = client.close()
print("TOTAL DE TIEMPO --- %s seconds --- (%s minutes)" % (time.time() - start_time,(time.time() - start_time)/60))